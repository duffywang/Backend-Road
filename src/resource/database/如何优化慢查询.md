## 慢查询优化实践

### 知识储备

内存数据库:速度快，成本高，索引：Map、平衡树、T树 ，应用Redis、Memchached
磁盘数据库:速度较快，成本适中（虚拟机，物理机），索引哈希，B+ ，应用：MySQL、Oracle
分布式数据库:速度较慢，容量大，存储：竖表、HDFS

SQL执行阶段
1. 客户端发送一个查询给服务器
2. 服务器先检查缓存，如果命中了缓存，立即返回结果
3. 服务器端进行SQL的解析，生成解析树
4. 再由优化器生成对应的执行计划
5. 根据执行计划，调用具体存储引擎（InnoDB）将结果返回给客户端



InnoDB引擎为什么要使用B+树
1、每个节点（数据页）为16K，叶子节点存储数据，非叶子节点不存储数据，只存储键值对
2、多叉树，减少层高，减少IO
3、叶子节点间存在顺序指针，只需要查询到起始节点的位置，在叶子节点中依次遍历即可，可实现查找、排序、分组
4、B+主索引存所有数据，即为聚簇索引，因为不能把数据存放在两个地方，故一个表只能有一个聚簇索引，B树辅助索引只存主键ID，需要回表再次查询
5、适用于全键值、键值范围、最左前缀查找

利用索引的好处
1、减少服务器扫描的数据量，提高查询效率
2、服务器避免排序和临时表

### 分析原因及解决套路

#### Explain用法
- table : 查询哪个表

- rows ： 预估扫描的行数

- ref ： 哪个字段和key一起使用

- key ： 使用的索引

- possible_keys ：可用的索引，不止一个

- key_len ：key的长度

- type ： ALL(扫描全表)、index(扫描全索引)、range(范围索引)、ref(索引，匹配单值)、const(主键或唯一键，只匹配一行)

- filtered ：此查询条件所过滤数据百分比

- extra：额外信息eg: Using index condition 、Using where 、Using Temporary


#### 慢查询治理思路

##### 索引层面

1、没有索引

2 where shopid > 10000000 VS where shopid > 50000000
前者没有使用索引，回表(即从索引查出是哪一行，再回到表中取出所有字段返回)导致全表扫描（当需要回表的数据量大于20%，MySQL会认为全表扫描会更快）
建议：
不使用select * ，索引覆盖所需要返回的字段
减少数据量（分页），数据量过大时考虑分页

3 where shopid > 234512 and update_days > -1 and buy_time > 300
只用到shopid的索引，索引效率低，查询到后还需要回表再过滤，导致效率严重下降
建议：
增加update_days 和 buy_time字段的索引

4、Order By /Group By /Distinct 避免临时表

##### SQL层面
避免不正确或低效的写法、避免复杂的SQL

1、limit 6000000 , 10
limit过大 ，limit A,B 会扫描 X+Y条数据，即当X过大时，扫描行数多导致慢查询
建议：
尽量使用id > xx LIMIT 10，建议分页遍历使用ID

2、
KEY shopid 
KEY poiid
KEY combined(shopid,poiid)
触发了索引merge  i2 && KEY combined
建议：
删除Key shopid索引
3、一个复杂SQL 还是多个简单SQL

##### 表库层

1、查看表状况 show table status like 'table_shop'
Rows : 180000000
Data_length : 30G
单表数据量过大，建议单表不超过1千万行

2、是否必须走主库
Master-Slave架构，主库单节点，容易成为资源瓶颈

3、范式：确保每列的原子性（不可分解）、唯一性
反范式：通过冗余字段，提高查询效率


##### 应用层

换存储引擎、缓存
业务逻辑优化

#### 基础规范
使用InnoDB存储引擎：支持事务、行级锁、并发性更好
数据表、数据字段必须加入中文注释，时间长了会忘记字段精确含义
禁止使用存储过程，视图，触发器，Event，数据库目的是存储和索引，计算逻辑应该放到服务层
禁止存储大文件和大照片，存储在文件系统中，数据库里存URI即可

#### 建表规范
字段非NULL，必填字段有default值
必须有主键，例如建议增加xxx_create ,xxx_update字段
主键选择较短的数据类型，
单表大小不要超过1千万行
注意索引的区分度

#### SQL注意事项
禁止在where条件的列名上使用函数
禁止使用左模糊或全模糊查询，如like '%abc' ,like '%abc%'
禁止使用大偏移量的limit分页
禁止3张表以上做join

推荐学习：
高性能SQL 和 MySQL官方文档(https://www.mysql.com)