### What ä»€ä¹ˆæ˜¯ç©ºæŒ‡é’ˆNullPointerException(NPE)

ç©ºæŒ‡é’ˆæ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼Œæ‰€ä»¥å°±å¯¼è‡´åœ¨ç¼–ç æ—¶ä¸æ˜“å‘ç°ï¼Œå› ä¸ºJavaä¸­å¯¹è±¡å¯ä»¥è®¾ä¸ºnullï¼Œå½“å»ä½¿ç”¨ä¸ºnullçš„å¯¹è±¡æ“ä½œæ—¶ä¼šæŠ›å‡ºç©ºæŒ‡é’ˆï¼ŒNullPointerException å®˜æ–¹è§£é‡ŠğŸ‘‡

> *NullPointerException is a RuntimeException. In Java, a special* null *value can be assigned to an object reference. NullPointerException is thrown when an application attempts to use an object reference that has the* null *value. These include:*
>
> - *Calling the instance method of a null object.*
> - *Accessing or modifying the field of a null object.*
> - *Taking the length of null as if it were an array.*
> - *Accessing or modifying the slots of null as if it were an array.*
> - *Throwing null as if it were a Throwable value.*



```java
public class NullPointerException extends RuntimeException {
    private static final long serialVersionUID = 5162710183389028792L;

    public NullPointerException() {
        super();
    }
    public NullPointerException(String s) {
        super(s);
    }
}
```

### Why ä¸ºä»€ä¹ˆè¦é¿å…

å…¬å¸å†…éƒ¨ CaseStudy å¹³å°æœ‰å¾ˆå¤šç©ºæŒ‡é’ˆå¼•èµ·çš„äº‹æ•…ï¼Œå…¶ä¸­ä¸€ä¸ªæ¶‰åŠé‡‘é¢ä¸º1,819,172å…ƒï¼Œé€€æ¬¾è®¢å•æ•°1662ï¼Œå®¢è¯‰50+ï¼Œä¸€è¡Œä»£ç å¯ä»¥é€ æˆè¿™ä¹ˆå¤§çš„å½±å“......

å¯ä»¥è¯´è¿™æ˜¯ä¸€ä¸ªç¼–ç¨‹ä¸­å‡ºç°æœ€é¢‘ç¹çš„bugï¼Œæœ‰äººè¯´70%ä»¥ä¸Šçš„å¼‚å¸¸éƒ½æ˜¯NullPointerException

å¦‚æœç¼–ç ä¸å°å¿ƒï¼Œå¯èƒ½ä¼šé€ æˆå¾ˆå¤§çš„æŸå¤±ï¼Œä½†åªè¦å…»æˆå¥½çš„ç¼–ç ä¹ æƒ¯ï¼ŒNPEå°±ä¸ä¼šå‡ºç°

### How æ¶ˆç­NPE

#### 1ã€å·²çŸ¥å¯¹è±¡æ”¾å‰

æ€»æ˜¯ä»å·²çŸ¥çš„éç©ºStringå¯¹è±¡ä¸­è°ƒç”¨equals()æ–¹æ³•ï¼Œequals()æ–¹æ³•æ˜¯å¯¹ç§°çš„ï¼Œa.equals(b)ä¸b.equals(a)æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œè¿™æ˜¯é¿å…ç©ºæŒ‡é’ˆçš„æœ€å¸¸è§çš„æŠ€å·§

```
//é”™è¯¯æ–¹å¼âŒ
if(ObjectA.equals("ObjectB")){
	 .....
}
//æ­£ç¡®æ–¹å¼âœ…
if(â€ObjectBâ€œ.equals(ObjectA)){
	 .....
}
//æ­£ç¡®æ–¹å¼âœ…
Boolean.TRUE.equals(a);
```



#### 2ã€å¯¹è±¡åˆ¤ç©º

```java
Objects.equals(obj1,obj2);

-------------------------------------------
public static boolean equals(Object a, Object b) {
   return (a == b) || (a != null && a.equals(b));
}
```



#### 3ã€ä½¿ç”¨contains()/containsKey()/containsValue()æ—¶æ³¨æ„

```java
HashMap<Object, Object> map = null;
//é”™è¯¯ç¤ºèŒƒâŒ
Object test = map.get("test");
//é”™è¯¯ç¤ºèŒƒâŒ
if (map.containsKey("test")){
    System.out.println(map.get("test"));
}
```



#### 4ã€ä½¿ç”¨ concat()/trim()æ—¶æ³¨æ„

```java
String str = null;
//é”™è¯¯ç¤ºèŒƒâŒ
str.concat("hello");
//é”™è¯¯ç¤ºèŒƒâŒ
str.trim();
```



#### 5ã€valueOf()ä¸toString()è¿”å›ç›¸åŒç»“æœæ—¶ï¼Œä½¿ç”¨å‰è€…

è°ƒç”¨nullå¯¹è±¡çš„toString()ä¼šæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œè€Œä½¿ç”¨valueOf()å¯ä»¥è·å¾—ç›¸åŒçš„å€¼,ä¼ é€’ä¸€ä¸ªnullç»™valueOf()å°†ä¼šè¿”å›nullï¼ŒInteger,Double,BigDecimal

```java
String s = null;
//é”™è¯¯æ–¹å¼âŒ
System.out.println(s.toString());
//æ­£ç¡®æ–¹å¼âœ…
System.out.println(String.valueOf(s)); 

----------------------------------
public static String valueOf(Object obj) {
     return (obj == null) ? "null" : obj.toString();
}
```



#### 6ã€ä¸å¿…è¦çš„è‡ªåŠ¨åŒ…è£…å’Œè‡ªåŠ¨è§£åŒ…

å¦‚æœwrapperç±»å¯¹è±¡æ˜¯nullï¼Œè‡ªåŠ¨åŒ…è£…åŒæ ·å®¹æ˜“å¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä»¥åŠint ä¸Integerç±»å‹

```java
public class Student {
    private Integer age;
    private String name;

    public Student(String name) {
        this.name = name;
    }
    //setter and getter
}

Student student = new Student("ram");
// NullPointerException
int age = student.getAge();
// è¿”å›null
Integer age = student.getAge();
```





#### 7ã€ä½¿ç”¨å·¥å…·ç±»StringUtilsï¼ŒåŒ…æ‹¬å¯¹nullå¯¹è±¡çš„åˆ¤æ–­

```java
//ä½¿ç”¨å·¥å…·åº“
System.out.println(StringUtils.isEmpty(null)); //true
System.out.println(StringUtils.isBlank(null)); //true
System.out.println(StringUtils.isNumeric(null)); //false
System.out.println(StringUtils.isAllUpperCase(null)); //false
```



#### 8ã€å…ˆåˆ›å»ºç©ºé›†åˆ

é€šè¿‡è¿”å›ä¸€ä¸ªç©ºçš„é›†åˆæˆ–è€…ç©ºæ•°ç»„ï¼Œé¿å…è¿”å›çš„æ˜¯ç©ºé›†åˆè€Œä¸æ˜¯nullï¼Œåœ¨ç¡®ä¿è°ƒç”¨size(),length()çš„æ—¶å€™ä¸ä¼šå› ä¸ºè¿”å›çš„æ˜¯null ï¼Œå¯ç”¨@NotNull æ³¨è§£

```java
Map emptyMap = Collections.EMPTY_MAP;
Set emptySet = Collections.EMPTY_SET;
List emptyList = Collections.EMPTY_LIST;
```



#### 9ã€é›†åˆæ­£ç¡®åˆ¤ç©ºæ–¹å¼

Apache Commons Lang åŒ…ä¸­CollectionUtilsç±»å¯ä»¥å¸®åŠ©å¿«é€Ÿåˆ¤ç©ºï¼Œé›†åˆå¯èƒ½ä¸ºç©º

```java
//é”™è¯¯æ–¹å¼âŒ
if(list.size() > 0){
   //do something
}

if(CollectionUtils.isEmpty(list)){
		//do something
}
-------------------------------------------
public static boolean isEmpty(Collection coll) {
   return (coll == null || coll.isEmpty());
}
```



#### 10ã€å¯¹éå†çš„æ•°ç»„å’Œé›†åˆè¿›è¡Œåˆ¤ç©º

é›†åˆå’Œæ•°ç»„å¯èƒ½ä¸ºnull,åœ¨è¿›è¡Œéå†å‰å…ˆè¿›è¡Œåˆ¤ç©ºå¤„ç†

```java
Collection<Integer> myNumbers = buildNumbers();
//æ­£ç¡®æ–¹å¼âœ…
if (CollectionUtils.isNotEmpty(myNumbers)) {
  for (Integer myNumber : myNumbers) {
    System.out.println(myNumber);
  }
}
```



#### 11ã€Optional

ä¸€è¿ä¸²è°ƒç”¨å¦‚obj.getA().getB().getC() ï¼Œå®¹æ˜“å‡ºç°NPEï¼Œä¸”é€šè¿‡ä¸‹é¢æ ¼å¼åˆ¤æ–­çš„è¯å½±å“ä»£ç å¯è¯»æ€§ï¼Œå¯ä½¿ç”¨Java 8 ä¸­Optionalï¼Œæ„Ÿå…´è¶£åŒå­¦å¯è‡ªè¡Œæœç´¢

```java
if (user != null) {
    Address address = user.getAddress();
    if (address != null) {
        Country country = address.getCountry();
        if (country != null) {
            String isocode = country.getIsocode();
            if (isocode != null) {
                isocode = isocode.toUpperCase();
            }
        }
    }
}                
```

Optionalç›®çš„æ˜¯å³ä¿è¯ç¨‹åºå¥å£®æ€§çš„åŒæ—¶ï¼Œåˆä¿æŒä»£ç çš„ä¼˜é›…å’Œå¯è¯»æ€§

```java
String str= Optional.ofNullable(getMsgFormDB())                    
                .map(d->d.trim())                                  
                .map(d->d.replace(getMsgFromWebService()))         
                .map(d->d.trim())                                  
                .orElseGet(() -> Strings.EMPTY);  
```



#### 12ã€ç›‘æ§æŠ¥è­¦

æœ€åä¸€ç‚¹ä¸æ˜¯ä»ä»£ç å±‚é¢ä¸Šå»æ¶ˆç­ï¼Œä½†ç›‘æ§æŠ¥è­¦æ˜¯é˜²æ­¢ç©ºæŒ‡é’ˆé€ æˆå½±å“çš„æœ€åä¸€é“é˜²çº¿ï¼Œä¸ºäº†åŠæ—¶å‘ç°é—®é¢˜ï¼Œä¸€èˆ¬è®¾ç½®NullPointerException > 1 å°±åº”è¯¥æŠ¥è­¦ä¸”æŠ¥è­¦çº§åˆ«é«˜ã€‚



### å°ç»“ï¼š

**ä¸€å†™ä»£ç æ—¶æ€è€ƒæ¸…æ¥šæ˜¯å¦å¯èƒ½ä¸ºç©ºæŒ‡é’ˆï¼ŒäºŒå†™å®Œä»£ç åè®¤çœŸæ£€æŸ¥ä¸€éï¼Œä¸‰ä½¿ç”¨æ’ä»¶å¦‚ Alibaba Java Coding Guidelines ã€FindBugsæ£€æŸ¥ä¸€é**